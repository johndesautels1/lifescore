# HANDOFF - LIFESCORE SCORING SYSTEM FIX

## Conversation ID: LIFESCORE-2026-0119-SCORING-AUDIT
## Date: January 19, 2026 01:00 Barcelona
## Status: READY TO IMPLEMENT FIXES

---

## CRITICAL: READ THESE FILES FIRST

1. **D:\LifeScore\CRITICAL_ISSUES_2026_0119.md** - All bugs documented
2. **D:\LifeScore\FIX_PLAN_2026_0119.md** - Exact code changes needed

---

## WHAT'S BROKEN

The scoring system is completely broken. LLMs return garbage because:

1. **${options} bug** - Line 216 in api/evaluate.ts outputs `[object Object]` instead of actual category options
2. **Advanced prompts missing** - Detailed prompts from `src/services/llmEvaluators.ts` were NEVER ported to `api/evaluate.ts`
3. **Perplexity schema conflict** - JSON schema forces numbers but prompt asks for categories

---

## WHAT NEEDS TO BE DONE

**Port prompts from `src/services/llmEvaluators.ts` (client) to `api/evaluate.ts` (server):**

| LLM | What to Port |
|-----|--------------|
| All | `buildEvaluationPrompt()` with scoring guidelines (0-100 scale) |
| Claude | Tavily context + addendum (already there, just needs scoring guidelines) |
| GPT-4o | Full `systemPrompt` with scoring scale |
| Gemini | `systemInstruction` + `safetySettings` |
| Grok | System message with scoring scale |
| Perplexity | Remove broken JSON schema, add scoring guidelines |

**Plus fix the ${options} bug (line 216):**
```typescript
// BROKEN:
${options}

// FIXED:
${options.map(o => `    - "${o.value}": ${o.label} → ${o.score}`).join('\n')}
```

---

## THE PROMPTS ARE GOOD

The prompts in `src/services/llmEvaluators.ts` from 24 hours ago are solid:
- Full scoring scale (0-100 with ranges defined)
- Dual scoring (Legal + Enforcement)
- Authoritative sources list
- Proper JSON format
- Safety settings for Gemini

Just need to COPY them to `api/evaluate.ts`.

---

## GIT REFERENCE

**Recent commits:**
```
6a7617a - Add detailed fix plan for scoring system - 8 specific fixes
31beebc - CRITICAL: Document all scoring system issues
8ffd14b - Trigger redeploy
c7059d7 - Fix Gemini API: googleSearchRetrieval → google_search
```

**Good prompts are in commit:** `c88ad36` (2026-01-18 03:11)

To view: `git show c88ad36:src/services/llmEvaluators.ts`

---

## QUICK START FOR NEXT SESSION

```
Continue LIFESCORE scoring system fix.

CRITICAL FILES TO READ FIRST:
1. D:\LifeScore\CRITICAL_ISSUES_2026_0119.md - All bugs
2. D:\LifeScore\FIX_PLAN_2026_0119.md - Exact fixes needed

TASK: Port prompts from src/services/llmEvaluators.ts to api/evaluate.ts

The prompts in client-side code are GOOD. They just need to be
copied to server-side api/evaluate.ts which Vercel actually runs.

Key fixes:
1. Line 216: Fix ${options} to format array properly
2. Add buildEvaluationPromptWithScoring function
3. Add detailed system prompts to all 5 LLMs
4. Add Gemini safety settings
5. Remove Perplexity broken JSON schema

Conversation ID: LIFESCORE-2026-0119-SCORING-FIX
```

---

## DO NOT MAKE CODE CHANGES WITHOUT USER APPROVAL
