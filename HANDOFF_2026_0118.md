# LIFE SCORE Scoring System Redesign - Agent Handoff Document

## Conversation ID: `LIFESCORE-2026-0118-SCORING-REDESIGN`
## Date: January 18, 2026

---

## CRITICAL: READ THESE FILES FIRST

1. **D:\LifeScore\IMPLEMENTATION_MASTER_PLAN.md** - Full 5-phase plan
2. **D:\LifeScore\SCORING_SYSTEM_REDESIGN.md** - Problem & solution details
3. **D:\LifeScore\PHASE2_EVALUATE_CHANGES.md** - Manual changes for api/evaluate.ts
4. **D:\LifeScore\PHASE4_CACHE_FIX.md** - Manual changes for cache.ts

---

## PROGRESS SUMMARY

### Phase 1: Shared Metrics Module
| Step | Description | Status |
|------|-------------|--------|
| 1.1 | Create `src/shared/types.ts` | ✅ COMPLETE |
| 1.2 | Create `src/shared/metrics.ts` with scoringCriteria | ✅ COMPLETE |
| 1.3 | Export `categoryToScore()` and `METRIC_SCORE_LOOKUP` | ✅ COMPLETE |
| 1.4 | Export `getCategoryOptionsForPrompt()` | ✅ COMPLETE |
| 1.5 | Update all 14 client imports | ✅ COMPLETE (committed) |
| 1.6 | Update api/evaluate.ts imports | ⏳ BLOCKED |

### Phase 2: Category-Based Prompts
| Step | Description | Status |
|------|-------------|--------|
| 2.1 | Add `USE_CATEGORY_SCORING` toggle | ⏳ BLOCKED |
| 2.2 | Create `buildCategoryPrompt()` function | ⏳ BLOCKED |
| 2.3 | Update each LLM evaluator | ⏳ BLOCKED |
| 2.4 | Update `parseResponse()` for category format | ⏳ BLOCKED |

### Phase 3: Opus Judge Update
| Step | Description | Status |
|------|-------------|--------|
| 3.1-3.3 | Update judge to validate category values | ⏳ PENDING |

### Phase 4: Cache Fix
| Step | Description | Status |
|------|-------------|--------|
| 4.1 | Add `ComparisonCacheEntry` interface | ⏳ BLOCKED |
| 4.2 | Update `getComparison()` | ⏳ BLOCKED |
| 4.3 | Update `setComparison()` | ⏳ BLOCKED |
| 4.4 | Add `swapCityOrder()` helper | ⏳ BLOCKED |

### Phase 5: Testing & Rollout
| Step | Description | Status |
|------|-------------|--------|
| 5.1-5.3 | Deploy and test | ⏳ PENDING |

---

## BLOCKING ISSUE

**Problem:** `api/evaluate.ts` and `src/services/cache.ts` are being modified by an external process (likely dev server, TypeScript watcher, VS Code formatter, or auto-save) between read and edit operations.

**Error:** "File has been unexpectedly modified"

**Solution for Next Session:**
1. **STOP ALL RUNNING PROCESSES** before editing:
   - Kill `npm run dev` or any dev server
   - Kill TypeScript watch mode (`npx tsc --watch`)
   - Disable VS Code auto-save or close VS Code
   - Stop any file watchers

2. Apply changes manually per the documentation files

---

## FILES MODIFIED THIS SESSION

| File | Change |
|------|--------|
| `src/App.tsx` | Import from `./shared/metrics` |
| `src/api/scoring.ts` | Import from `../shared/metrics` |
| `src/components/AdvancedVisuals.tsx` | Import from `../shared/metrics` |
| `src/components/DealbreakersPanel.tsx` | Import from `../shared/metrics` |
| `src/components/DealbreakersWarning.tsx` | Import from `../shared/metrics` |
| `src/components/EnhancedComparison.tsx` | Import from `../shared/metrics` |
| `src/components/LoadingState.tsx` | Import from `../shared/metrics` |
| `src/components/Results.tsx` | Import from `../shared/metrics` |
| `src/components/WeightPresets.tsx` | Import from `../shared/metrics` |
| `src/hooks/useComparison.ts` | Import from `../shared/metrics` |
| `src/services/enhancedComparison.ts` | Import from `../shared/metrics` |
| `src/services/llmEvaluators.ts` | Import from `../shared/metrics` |
| `src/services/opusJudge.ts` | Import from `../shared/metrics` |
| `src/utils/exportUtils.ts` | Import from `../shared/metrics` |

## FILES CREATED THIS SESSION

| File | Purpose |
|------|---------|
| `PHASE2_EVALUATE_CHANGES.md` | Step-by-step instructions for api/evaluate.ts |
| `PHASE4_CACHE_FIX.md` | Step-by-step instructions for cache.ts fix |

---

## THE PROBLEM (Why This Redesign)

Cities show **identical scores** (e.g., 65 vs 65) because:
1. Current system uses generic A-E letter grades
2. LLMs interpret grades differently
3. A → 90, B → 75, C → 50, D → 25, E → 10 produces bland averages

**Example:** Austin vs Denver both get "B" for cannabis → both get 75 → no differentiation

---

## THE SOLUTION (Category-Based Scoring)

Instead of generic letter grades:
```
A = 90-100
B = 70-89
...
```

Use **metric-specific category values**:
```typescript
// For pf_01_cannabis_legal:
{
  "fully_legal": { score: 100 },
  "medical_only": { score: 50 },
  "decriminalized": { score: 40 },
  "illegal": { score: 0 }
}
```

LLM returns: `"city1Category": "fully_legal"`
Server looks up: `score = 100`

**Result:** Colorado (fully_legal=100) vs Texas (medical_only=50) = clear differentiation!

---

## CACHE BUG EXPLANATION

**Problem:** In `src/services/cache.ts`, the cache key sorts cities alphabetically:
```typescript
const [a, b] = [city1, city2].sort();
return `comparison:${a}:${b}:${llmsHash}`;
```

So "Austin vs Denver" and "Denver vs Austin" use the **SAME** cache key.

But the cached result has city1/city2 in their **original order**.

**Result:** If "Austin vs Denver" is cached, then "Denver vs Austin" returns cached result where city1=Austin, city2=Denver - **WRONG ORDER**.

**Fix:** Store `originalCity1` and `originalCity2` with cached data, swap on retrieval if needed.

---

## NEXT STEPS FOR NEW SESSION

1. **Stop all file watchers/dev servers**

2. **Apply Phase 2 changes to api/evaluate.ts:**
   - Add imports (line 6)
   - Add `USE_CATEGORY_SCORING` toggle (line 9)
   - Add `MetricWithCriteria` interface
   - Add `buildCategoryPrompt()` function
   - Update `parseResponse()` for category format
   - Update each LLM evaluator function

3. **Apply Phase 4 changes to src/services/cache.ts:**
   - Add `ComparisonCacheEntry` interface
   - Update `getComparison()` to check city order
   - Update `setComparison()` to store original order
   - Add `swapCityOrder()` helper method

4. **Test with `USE_CATEGORY_SCORING=false` first** (legacy mode)

5. **Enable `USE_CATEGORY_SCORING=true`** and verify differentiation

---

## KEY FILES REFERENCE

| File | Purpose |
|------|---------|
| `src/shared/metrics.ts` | New shared metrics with scoringCriteria, categoryToScore() |
| `src/shared/types.ts` | ScoreResult type definition |
| `api/evaluate.ts` | Vercel serverless function - needs Phase 2 changes |
| `src/services/cache.ts` | Caching service - needs Phase 4 fix |
| `IMPLEMENTATION_MASTER_PLAN.md` | Full 5-phase plan |
| `SCORING_SYSTEM_REDESIGN.md` | Detailed problem/solution |

---

## GIT STATUS

**Latest Commit:** `97f2385` - Phase 1.5: Update client imports from data/metrics to shared/metrics

**Branch:** main

**Remote:** https://github.com/johndesautels1/lifescore.git

---

## ENVIRONMENT VARIABLES FOR TESTING

When testing Phase 2:
```
USE_CATEGORY_SCORING=false  # Start here (legacy mode)
USE_CATEGORY_SCORING=true   # Enable after verification
```

Set in Vercel dashboard under Environment Variables.
