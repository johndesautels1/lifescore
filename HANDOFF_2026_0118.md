# LIFE SCORE Scoring System Redesign - Agent Handoff Document

## Conversation ID: `LIFESCORE-2026-0118-SCORING-REDESIGN`
## Date: January 18, 2026
## Status: PHASE 2 & 4 CODE COMPLETE - PRODUCTION FIX REQUIRED

---

## ðŸš¨ CRITICAL: FIX REQUIRED BEFORE DEPLOYMENT

**The API is broken in production.** Phase 2 imports cannot be resolved by Vercel serverless.

**Error:** `Cannot find module '/var/task/src/shared/metrics'`

**Cause:** `api/evaluate.ts` imports from `../src/shared/metrics` but Vercel serverless functions only have access to files in the `api/` folder at runtime.

### FIX OPTIONS (Choose One)

**Option 1: Vercel includeFiles (Recommended)**
Add to `vercel.json`:
```json
{
  "functions": {
    "api/evaluate.ts": {
      "maxDuration": 300,
      "includeFiles": "src/shared/**"
    }
  }
}
```

**Option 2: Copy shared code to api/ folder**
- Create `api/shared/metrics.ts` with the scoring logic
- Update imports in `api/evaluate.ts` to use `./shared/metrics`

**Option 3: Remove Phase 2 imports (Quick Rollback)**
- Remove the broken imports from `api/evaluate.ts` lines 7-9
- Keep legacy A-E letter grading (USE_CATEGORY_SCORING stays false)

---

## COMPLETED THIS SESSION

| Phase | Task | Commit | Status |
|-------|------|--------|--------|
| 1.5 | Update 14 client imports | `97f2385` | âœ… COMPLETE |
| 2 | Category-based scoring in api/evaluate.ts | `cca20c5` | âœ… CODE COMPLETE |
| 4 | Cache city order bug fix | `aa69899` | âœ… COMPLETE |
| - | Fix TypeScript build errors | `7916568` | âœ… COMPLETE |
| - | Document critical API fix in README | `02367fa` | âœ… COMPLETE |

### All Commits This Session (10 total)

```
02367fa Document critical API fix needed for Vercel serverless imports
7916568 Fix TypeScript build errors in cache.ts and metrics.ts
aa69899 Phase 4 COMPLETE: Fix cache city order bug
cca20c5 Phase 2 COMPLETE: All 5 LLM evaluators use category-based scoring
a308dc2 Phase 2: Update parseResponse and Claude evaluator for category scoring
3925938 Phase 2 partial: Add category-based scoring imports and foundation
a792cdf Add agent handoff document for next session
97f2385 Phase 1.5: Update client imports from data/metrics to shared/metrics
f777e25 Phase 1.1-1.4: Create shared metrics module with O(1) lookup
efc05c2 Add comprehensive scoring system redesign documentation
```

---

## REMAINING TASKS

### IMMEDIATE: Fix Vercel Import Issue
- Choose one of the 3 fix options above
- Test deployment works

### Phase 3: Opus Judge Update (PENDING)
- Update api/judge.ts to validate category values returned by LLMs
- Ensure judge understands category-based scoring

### Phase 5: Testing & Rollout (PENDING)
1. Deploy with `USE_CATEGORY_SCORING=false` (default) - verify legacy mode works
2. Enable `USE_CATEGORY_SCORING=true` in Vercel env vars
3. Test Austin vs Denver - verify cities show different scores
4. Test Denver vs Austin - verify cache returns correct city order

---

## WHAT WAS IMPLEMENTED

### Phase 2: Category-Based Scoring (api/evaluate.ts)

**Problem:** Generic A-E grades produced identical scores (65 vs 65) for different cities.

**Solution:** LLMs now return metric-specific category VALUE KEYS:
```typescript
// Instead of:  city1Legal: "B"  â†’ 75
// Now returns: city1Category: "fully_legal" â†’ 100 (looked up from scoringCriteria)
```

**Changes:**
- Import `categoryToScore`, `getCategoryOptionsForPrompt` from shared/metrics
- `USE_CATEGORY_SCORING` env toggle for gradual rollout
- `buildCategoryPrompt()` asks LLMs for category values instead of letter grades
- `parseResponse()` uses `categoryToScore()` when category response detected
- All 5 LLM evaluators conditionally use `buildCategoryPrompt()`

### Phase 4: Cache City Order Fix (src/services/cache.ts)

**Problem:** Cities sorted for cache key, but result had original order.
"Austin vs Denver" and "Denver vs Austin" used SAME key but returned wrong city.

**Solution:**
- Store `originalCity1` and `originalCity2` with cached data
- On retrieval, check if cities need swapping
- `swapCityOrder()` swaps city1/city2 objects and winner/categoryWinners values

---

## KEY FILES REFERENCE

| File | Purpose |
|------|---------|
| `src/shared/metrics.ts` | Shared metrics with scoringCriteria, categoryToScore() |
| `src/shared/types.ts` | ScoreResult type |
| `api/evaluate.ts` | Category-based LLM prompts and parsing (HAS BROKEN IMPORTS) |
| `src/services/cache.ts` | Fixed city order bug |
| `vercel.json` | Needs includeFiles config for Option 1 fix |
| `README.md` | Has critical fix documentation at top |
| `IMPLEMENTATION_MASTER_PLAN.md` | Full 5-phase plan |
| `SCORING_SYSTEM_REDESIGN.md` | Problem/solution details |

---

## FOR NEXT SESSION

```
Continue LIFE SCORE scoring system implementation.

ðŸš¨ FIRST: Fix the Vercel serverless import issue (see README.md top section)

COMPLETED: Phase 1 (all), Phase 2 (code complete), Phase 4 (complete)

REMAINING:
1. Fix Vercel import issue (Option 1 recommended: add includeFiles to vercel.json)
2. Phase 3: Update api/judge.ts for category validation
3. Phase 5: Deploy and test with USE_CATEGORY_SCORING=true

READ: D:\LifeScore\README.md for critical fix documentation
READ: D:\LifeScore\IMPLEMENTATION_MASTER_PLAN.md for full context

Conversation ID: LIFESCORE-2026-0118-SCORING-REDESIGN
```

---

## GIT STATUS

**Latest Commit:** `02367fa` - Document critical API fix needed for Vercel serverless imports

**Branch:** main

**Remote:** https://github.com/johndesautels1/lifescore.git
