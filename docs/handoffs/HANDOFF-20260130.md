# LIFE SCORE - Agent Handoff Document
**Date:** 2026-01-30
**Session ID:** LS-BUGS-20260129-B (continued)

---

## CRITICAL: User Must Do This First

**Add Vercel Environment Variable:**
```
WEBHOOK_BASE_URL = https://clueslifescore.com
```
This fixes the Replicate webhook 401 errors. The webhook was using preview deployment URLs which have Vercel Authentication enabled.

---

## Completed This Session

1. **Fixed runaway video-status polling** - JudgeTab.tsx was polling 100+ times/second due to useEffect dependency on object instead of string ID. Added `checkedComparisonIdRef` guard.

2. **Fixed .single() to .maybeSingle()** - Changed 27+ locations across the codebase to prevent "Cannot coerce to single JSON object" errors when queries return 0 rows.

3. **Fixed Olivia interrupt** - Enhanced useSimli.ts and useAvatarProvider.ts to properly stop audio when user clicks pause/stop.

4. **Fixed Judge video to use Wav2Lip** - Configured Wav2Lip settings in generate-judge-video.ts:
   - Fixed CHRISTIANO_IMAGE_URL from MP4 to PNG

5. **Added avatar API routes to vercel.json** - The three avatar API routes were missing from vercel.json functions config, causing 404 errors:
   - `api/avatar/generate-judge-video.ts`
   - `api/avatar/video-status.ts`
   - `api/avatar/video-webhook.ts`

7. **Fixed button text sizing** - JudgeTab.css action buttons (SAVE REPORT, DOWNLOAD PDF, DOWNLOAD VIDEO, FORWARD) - removed width constraints so text fits.

---

## Pending Tasks

### 1. Olivia Context Loading from Dropdown (Bug 2/3)
**File:** `src/hooks/useOliviaChat.ts`

When user selects a different comparison from the dropdown in Ask Olivia page, Olivia should load the full comparison data. Currently may use stale context.

**Fix needed:** Reset context immediately when comparison changes, wait for new context to load before allowing messages.

### 2. Add Cancel Button for Judge Video Generation
**File:** `src/components/JudgeTab.tsx` (around line 1094-1107)

When video is generating (showing "GENERATING VIDEO" state), there's no way for user to cancel. Add a cancel button that:
- Calls Replicate API to cancel the prediction
- Updates the local state
- Clears the video generation status

### 3. Stuck Replicate Predictions
User had 3 stuck predictions that may still be running:
- `repa13a6e5rg80cw1f88t8yzfc`
- `7jxq5s3wv1rge0cw1f7srve0bw`
- `t9jdct1cyxrgc0cw1eybwgkdpm`

Can cancel via:
```bash
curl -X POST https://api.replicate.com/v1/predictions/{id}/cancel \
  -H "Authorization: Token $REPLICATE_API_TOKEN"
```

---

## Key Files Modified

- `api/avatar/generate-judge-video.ts` - GPU settings, image URL
- `api/avatar/video-status.ts` - maybeSingle() fix
- `src/components/JudgeTab.tsx` - polling fix, CSS classes
- `src/components/JudgeTab.css` - button text sizing
- `src/hooks/useSimli.ts` - interrupt functionality
- `src/hooks/useAvatarProvider.ts` - interrupt functionality
- `src/hooks/useOliviaChat.ts` - needs context reset fix
- 27+ API files - maybeSingle() fixes

---

## Environment Variables Needed

```
WEBHOOK_BASE_URL=https://clueslifescore.com  # CRITICAL - add this now
REPLICATE_API_TOKEN=<token>
REPLICATE_DEPLOYMENT_OWNER=johndesautels1
REPLICATE_DEPLOYMENT_NAME=james-bond
CHRISTIANO_IMAGE_URL=https://replicate.delivery/pbxt/OUrlfPYTJP3dttVkSYXUps6yUmzZbLTdVdrut77q48Tx7GfI/enhanced_avatar_max.png
```

---

## User Frustrations to Note

- User is extremely frustrated with repeated failures on button text sizing
- User expects immediate fixes, not explanations
- User wants direct action, not suggestions to check things themselves
- Do not make excuses about "dev server" or other external factors
- Verify changes actually work before claiming they're fixed
