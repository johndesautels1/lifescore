# LIFE SCORE Handoff Document
**Conversation ID:** LS-BUG-20260125-001
**Date:** 2026-01-25
**Status:** Multiple fixes deployed, testing needed

---

## COMPLETED THIS SESSION

### 1. Results Page Bug - FIXED ‚úÖ
**Commit:** `d2f73aa`
- Results tab wasn't opening after enhanced comparison
- Root cause: No error handling in `onResultsUpdate` callback in App.tsx
- Added try-catch, .catch(), and validation of judge result structure
- Added `[App]` console logging to trace flow

### 2. Cost Tracking Wiring - NEEDS VERIFICATION ‚ö†Ô∏è
**Commits:** `9548d78`, `e2f6b7b`, `2fa69ad`

**What was done:**
- `llmEvaluators.ts`: Added `TokenUsage`, `TavilyUsage` types, capture usage from `/api/evaluate` responses
- `opusJudge.ts`: Added `usage.opusTokens` to `JudgeOutput` type
- `App.tsx`: After enhanced comparison completes, builds `ComparisonCostBreakdown` and calls `storeCostBreakdown()`

**Files modified:**
- `src/services/llmEvaluators.ts` - captures usage, aggregates across categories
- `src/services/opusJudge.ts` - JudgeOutput type includes usage
- `src/App.tsx` - builds and stores cost breakdown

**VERIFY:** Run enhanced comparison, check console for `[App] Cost tracking stored:` log, then open Cost Dashboard to see if data appears.

### 3. Gemini Business_Work Token Fix - FIXED ‚úÖ
**Commit:** `732b461`
- Gemini was failing on business_work (25 metrics) with error: "8241 tokens exceeds 8192 limit"
- Tightened conciseness requirements for large categories:
  - "1-2 sentences (50 words)" ‚Üí "1 sentence (25 words)"
  - "1-2 sources" ‚Üí "1 source"
- Only affects Gemini, only for categories with 20+ metrics
- **File:** `api/evaluate.ts` lines 895-900

### 4. Judge Video Generation - COMPLETE OVERHAUL ‚úÖ
**Commits:** `fdef8ee`, `19c0dfd`

**Problem:** SadTalker requires audio URL, but code was passing script TEXT.

**Fixed flow:**
1. Script ‚Üí ElevenLabs/OpenAI TTS ‚Üí Audio buffer
2. Upload audio to Supabase Storage ‚Üí Get public URL
3. Submit audio URL + Christiano image to Replicate SadTalker
4. Webhook receives completion, updates database

**Files created/modified:**
- `api/avatar/generate-judge-video.ts` - Complete rewrite with TTS + upload flow
- `api/avatar/video-webhook.ts` - NEW - Replicate webhook handler
- `supabase/migrations/20260125_create_judge_tables.sql` - Table definitions

**Supabase tables created (user ran SQL):**
- `avatar_videos` - caches generated videos
- `judge_reports` - saves judge reports

**Required env vars (user configured in Vercel):**
- `REPLICATE_API_TOKEN` ‚úÖ
- `ELEVENLABS_API_KEY` ‚úÖ
- `SUPABASE_URL` ‚úÖ
- `SUPABASE_SERVICE_KEY` ‚úÖ (new sb_secret_... format)

---

## NEEDS TESTING

### 1. Cost Tracking End-to-End
- Run enhanced comparison with 2+ LLMs
- Check console for `[App] Cost tracking stored:` with breakdown
- Open Cost Dashboard (üí∞ icon) - should show comparison with actual costs
- If no data: APIs may not be returning usage field - check network tab

### 2. Judge Video Generation
- Run enhanced comparison
- Go to Judge tab ‚Üí Generate Report
- Click video button
- Check Vercel logs for:
  ```
  [JUDGE-VIDEO] Generating TTS audio...
  [JUDGE-VIDEO] Uploading audio to Supabase Storage...
  [JUDGE-VIDEO] Submitting to Replicate SadTalker...
  [JUDGE-VIDEO] Prediction started: xxx
  ```

### 3. Gemini Business_Work
- Run enhanced comparison with Gemini
- All 6 categories should succeed now (was 5/6 before)
- Check for `gemini-3-pro/business_work: success=true`

---

## KNOWN ISSUES NOT YET ADDRESSED

1. **Cost tracking may not show data** - If APIs aren't returning `usage` field, the client won't have data to store. Need to verify API responses include usage.

2. **Christiano voice ID** - RESOLVED 2026-01-29: Now using custom ElevenLabs voice (`ZpwpoMoU84OhcbA2YBBV`). Both Replicate and D-ID fallback use this voice for consistency. Env var: `ELEVENLABS_CHRISTIANO_VOICE_ID`

---

## KEY FILES REFERENCE

| Feature | Files |
|---------|-------|
| Cost tracking types | `src/utils/costCalculator.ts` |
| Cost dashboard UI | `src/components/CostDashboard.tsx` |
| LLM evaluators + usage | `src/services/llmEvaluators.ts` |
| Judge output types | `src/services/opusJudge.ts` |
| Cost storage call | `src/App.tsx` lines 434-502 |
| Gemini prompt | `api/evaluate.ts` lines 882-901 |
| Judge video API | `api/avatar/generate-judge-video.ts` |
| Video webhook | `api/avatar/video-webhook.ts` |
| Supabase tables | `supabase/migrations/20260125_create_judge_tables.sql` |

---

## LATEST COMMIT
`2fa69ad` - Fix remaining TypeScript error - add usage to allResults type

All changes pushed to GitHub, Vercel deploying.
